name: Dev Pipeline
on:
  push:
    branches:
      - develop
  workflow_dispatch:



jobs:
  python_version:
    name: Determine Python version
    runs-on: ubuntu-latest
    outputs:
      python_version: ${{ steps.detect.outputs.python_version }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        run: |
          PY_VERSION="$(awk '/^python[[:space:]]+/ {print $2}' .tool-versions)"
          if [[ -z "$PY_VERSION" ]]; then
            echo "Unable to find Python version in .tool-versions" >&2
            exit 1
          fi
          echo "python_version=$PY_VERSION" >> "$GITHUB_OUTPUT"
  lint:
    name: Ruff lint
    runs-on: ubuntu-latest
    needs: python_version
    defaults:
      run:
        shell: bash
        working-directory: server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.python_version.outputs.python_version }}
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:  
          JF_URL: ${{ vars.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      - name: Set CLI Config
        run: jf pip-config --global=true --repo-resolve=lta-pypi
      - name: Install dependencies
        run: jf pip install -r requirements-dev.txt
      - name: Ruff check
        run: ruff check .
  format:
    name: Black format
    runs-on: ubuntu-latest
    needs: python_version
    defaults:
      run:
        shell: bash
        working-directory: server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.python_version.outputs.python_version }}
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:  
          JF_URL: ${{ vars.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      - name: Set CLI Config
        run: jf pip-config --global=true --repo-resolve=lta-pypi
      - name: Install dependencies
        run: jf pip install -r requirements-dev.txt
      - name: Black check
        run: black -S -l 80 --check .
  build_lambda:
    name: Build & Publish Lambda
    runs-on: ubuntu-latest
    needs:
      - python_version
      - lint
      - format
    defaults:
      run:
        shell: bash
        working-directory: server
    env:
      JF_URL: ${{ vars.JF_URL }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.python_version.outputs.python_version }}
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
      - name: Setting up Python Repo
        run: jf pipc --global=true --repo-resolve=${{ vars.PYPI_REPOSITORY }}
      - name: Build the lambda
        run: |
          code_dir="dist/lambda_code"
          deps_dir="dist/lambda_deps"
          code_artifact="dist/liquibase-todo-app-code.zip"
          deps_artifact="dist/liquibase-todo-app-deps.zip"
      
          mkdir -p "$code_dir" "$deps_dir"

          jf pip install -r requirements.txt --target "$deps_dir" --build-name ${{ vars.PYPI_BUILD_NAME }} --build-number ${{ github.run_number }} --project ${{ vars.PROJECT_KEY }}

          rsync -a --exclude '__pycache__' --exclude '*.pyc' app "$code_dir"
          cp lambda_handler.py "$code_dir/"

          (cd "$code_dir" && zip -qr "../$(basename "$code_artifact")" .)
          (cd "$deps_dir" && zip -qr "../$(basename "$deps_artifact")" .)

          jf rt u $deps_artifact "lta-package/${GITHUB_SHA}/" --build-name ${{ vars.PYPI_BUILD_NAME }} --build-number ${{ github.run_number }} --project ${{ vars.PROJECT_KEY }}
          jf rt u $code_artifact "lta-distribution/${GITHUB_SHA}/" --build-name ${{ vars.PYPI_BUILD_NAME }} --build-number ${{ github.run_number }} --project ${{ vars.PROJECT_KEY }}

      - name: Publish build info with JFrog CLI
        run: |
          jf rt bp ${{ vars.PYPI_BUILD_NAME }} ${{ github.run_number }} \
            --collect-env \
            --collect-git-info \
            --dot-git-path ../.git \
            --project ${{ vars.PROJECT_KEY }}
