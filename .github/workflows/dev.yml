name: Dev Pipeline
on:
  push:
    branches:
      - develop
  workflow_dispatch:



jobs:
  python_version:
    name: Determine Python version
    runs-on: ubuntu-latest
    outputs:
      python_version: ${{ steps.detect.outputs.python_version }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        run: |
          PY_VERSION="$(awk '/^python[[:space:]]+/ {print $2}' .tool-versions)"
          if [[ -z "$PY_VERSION" ]]; then
            echo "Unable to find Python version in .tool-versions" >&2
            exit 1
          fi
          echo "python_version=$PY_VERSION" >> "$GITHUB_OUTPUT"
  lint:
    name: Ruff lint
    runs-on: ubuntu-latest
    needs: python_version
    defaults:
      run:
        shell: bash
        working-directory: server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.python_version.outputs.python_version }}
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:  
          JF_URL: ${{ vars.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      - name: Set CLI Config
        run: jf pip-config --global=true --repo-resolve=lta-pypi
      - name: Install dependencies
        run: jf pip install -r requirements-dev.txt
      - name: Ruff check
        run: ruff check .
  format:
    name: Black format
    runs-on: ubuntu-latest
    needs: python_version
    defaults:
      run:
        shell: bash
        working-directory: server
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.python_version.outputs.python_version }}
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:  
          JF_URL: ${{ vars.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      - name: Set CLI Config
        run: jf pip-config --global=true --repo-resolve=lta-pypi
      - name: Install dependencies
        run: jf pip install -r requirements-dev.txt
      - name: Black check
        run: black -S -l 80 --check .
  build_lambda:
    name: Build & Publish Lambda
    runs-on: ubuntu-latest
    needs:
      - python_version
      - lint
      - format
    defaults:
      run:
        shell: bash
        working-directory: server
    env:
      JF_URL: ${{ vars.JF_URL }}
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      JFROG_CLI_BUILD_NAME: liquibase-todo-app
      JFROG_CLI_BUILD_PROJECT: lta
      JFROG_CLI_BUILD_NUMBER: ${{ github.run_number }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.python_version.outputs.python_version }}
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
      - name: Setting up Python Repo
        run: jf pipc --global=true --repo-resolve=lta-pypi
      - name: Build the lambda
        run: |
          dist_dir="$PWD/dist"
          code_dir="$dist_dir/lambda_code"
          deps_dir="$dist_dir/lambda_deps
          code_artifact="$dist_dir/liquibase-todo-app-code.zip"
          deps_artifact="$dist_dir/liquibase-todo-app-deps.zip"
          
          mkdir -p "$code_dir" "$deps_dir"
          
          jf pip install -r requirements.txt --target "$deps_dir" --build-name $JFROG_CLI_BUILD_NAME --build-number ${{ github.run_number }} --project $JFROG_CLI_BUILD_PROJECT --module=exp-lambda

          rsync -a --exclude '__pycache__' --exclude '*.pyc' app "$code_dir"
          cp lambda_handler.py "$code_dir/"

          (cd "$code_dir" && zip -r "$code_artifact" .)
          (cd "$deps_dir" && zip -r "$deps_artifact" .)

          jf rt u $deps_dir "lta-distribution/${GITHUB_SHA}/" --build-name $JFROG_CLI_BUILD_NAME --build-number ${{ github.run_number }} --project $JFROG_CLI_BUILD_PROJECT --module=exp-lambda

      - name: Publish build info with JFrog CLI
        run: |
          jf rt bce $JFROG_CLI_BUILD_NAME ${{ github.run_number }} --project $JFROG_CLI_BUILD_PROJECT
          jf rt bag $JFROG_CLI_BUILD_NAME ${{ github.run_number }} --project $JFROG_CLI_BUILD_PROJECT
          jf rt bp $JFROG_CLI_BUILD_NAME ${{ github.run_number }} --project $JFROG_CLI_BUILD_PROJECT
